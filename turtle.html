<html>
  <head>
    <script type="text/javascript">
     // The turtle prototype will be cloned to create new turtles
     // 
     var TurtleProto = {
       drawing: false,
       color: "#000",
       thickness: 1,
       x:0,
       px:0,
       maxX:420,
       y:0,
       py:0,
       maxY:350,
       facing: "Right",
       _rotation: 0,
       speed: 5,
       $elt: null,
       currentLineStart: null,

       _constructor: function (){ Object.assign(this, TurtleProto); },
       
       clone: function(){ // static function
         var o = new TurtleProto._constructor();
         o.$elt = document.createElement('div');
         var img = document.createElement('img');
         o.$elt.append(img);
         o.$elt.$img = img;
         var d = document.createElement('div');
         d.className = 'bg';
         o.$elt.prepend(d);
         o.$elt.$bg = d;
         o.$elt.className = 'turtle right';
         img.src = "turtleico_tran.png";
         o.$elt.setAttribute('style', 'position:absolute; left:0px;top:0px;height:32px;width:32px;rotate:0deg;')
         o.$elt.style.position = "absolute";
         o.$elt.style.left = this.x;
         o.$elt.style.top = this.y;
         o.$elt.style.height = 32;
         o.$elt.style.width = 32;
         o.$board = window.document.querySelector('.board')
         o.$board.prepend(o.$elt);
         o.maxX = o.$board.clientWidth;
         o.maxY = o.$board.clientHeight;
         return o;
       },
       
       _checkX: function(){
         if(this.x < 0){
           this.x = this.maxX;
           this._startNewLine();
         }
         else if(this.x > this.maxX){
           this.x = 0;
           this._startNewLine();
         }
       },
       
       _checkY: function(){
         if(this.y < 0){
           this.y = this.maxY;
           this._startNewLine();
         }
         else if(this.y > this.maxY){
           this.y = 0;
           this._startNewLine();
         }
       },
       
       _maybeChangeDirection: function(facing){
         if(this.facing != facing){
           this.prevFacing = facing;
           this.facing = facing;
           this._startNewLine();
         }
       },
       
       left: function(){
         this._maybeChangeDirection("Left");
         this.px = this.x;
         this.py = this.y;
         this.x -= this.speed;
         this._checkX();
         this._rotation=180;
         this.render();
       },
       
       right: function(){
         this._maybeChangeDirection("Right");
         this.px = this.x;
         this.py = this.y;
         this.x += this.speed;
         this._checkX();
         this._rotation=0;
         this.render();
       },
       
       up: function(){
         this._maybeChangeDirection("Up");
         this.py = this.y;
         this.px = this.x;
         this.y -= this.speed;
         this._checkY();
         this._rotation=270;
         this.render();
       },
       down: function(){
         this._maybeChangeDirection("Down");
         this.py = this.y;
         this.px = this.x;
         this.y += this.speed;
         this._checkY();
         this._rotation=90;
         this.render();
       },

       _startNewLine: function(x, y){
         if(!this.drawing) return false;
         console.log('Starting new line', x, y);
         if( x == null ) x = this.x;
         if( y == null ) y = this.y;
         var l = this.currentLine = {
           sx:x,
           sy:y,
           ex:x,
           ey:y,
           height:0,
           width:0,
           thickness: this.thickness,
           $elt: document.createElement('div'),
         };
         l.$elt.className = 'line';
         l.$elt.style.top = y+'px';
         l.$elt.style.left = x+'px';
         l.$elt.style.backgroundColor = this.color;
         this.$board.append(l.$elt);
       },

       setColor: function(c){
         this.color = c;
         this.render();
       },
       
       _renderLine: function(x, y){
         if(!this.drawing) return null;
         if(!x) x = this.x;
         if(!y) y = this.y;

         var l = this.currentLine;
         //console.log(l, x, y, this.px, this.py);
         if (l.sx == x) {
           var y2 = l.sy, y1 = l.ey;
           l.sy = Math.min(y2, y);
           l.ey = Math.max(y1, y);
         }
         else if(l.sy == y){
           var x2 = l.sx, x1 = l.ex;
           l.sx = Math.min(x2, x);
           l.ex = Math.max(x1, x);
         }
         l.height = (l.ey - l.sy) + l.thickness;
         l.width = (l.ex - l.sx) + l.thickness;
         l.$elt.style.left = l.sx;
         l.$elt.style.top = l.sy;
         l.$elt.style.width = l.width+'px';
         l.$elt.style.height = l.height+'px';
       },
       
       toggleDrawing: function(){
         this.drawing = !this.drawing;
         console.log('Toggling drawing', this.drawing)
         if(this.drawing){
           this._startNewLine();
         }else{
           this.currentLine = null;
         }
       },
       render: function(){
         this.$elt.$bg.style.backgroundColor = this.color;
         this.$elt.style.left = this.x+'px';
         this.$elt.style.top = this.y+'px';
         this.$elt.style.transform = 'rotate('+this._rotation+'deg)';
         this.$elt.className = 'turtle '+this.facing.toLowerCase();
         this._renderLine();
       },


     };

     var KeyHandler = {
       press: function (o, event){
         // make keys standard across apis (ArrowUp -> Up)
         var key = event.code.replace('Arrow','');
         var fn = KeyHandler.keyHandlers[key];
         console.log('keypress', event, key, fn, o);
         if(fn){ fn(o); }
       },
       keyHandlers: {
         Left:  function(o){ o.left(); },
         Right: function(o){ o.right(); },
         Up:    function(o){ o.up(); },
         Down:  function(o){ o.down() },
         Space: function(o){ o.toggleDrawing(); },
       },
     }

     // onEvent('screen1', "keydown", function(event){ turtle.keyPressHandler(event); });
     window.onload = function(){
       var turtle = window.turtle = TurtleProto.clone();
       window.document.body.addEventListener("keydown", function(event){
         KeyHandler.press(turtle, event);
       });
     };


     
    </script>
    <style>

     .turtle { height:32px; width:32px; position:relative; padding:0px; clear:both; }
     .turtle .bg {background-color:black; border-radius:16px; 
       width:28px; height:24px; position:absolute; top:4px; left:1px; z-index:1; }
     .turtle img {height:32px; width:32px;z-index:10; position:absolute;}
     .turtle.right {margin-top:-16px;}
     .turtle.left {margin-top:-16px; margin-left:-32px;}
     .turtle.down {margin-left:-16px;}
     .turtle.up {margin-top:-32px; margin-left:-16px;}
     .board {margin:15px; border:3px solid #00A; max-width:1000px; min-height:500px; position:relative;}
     .line { position:absolute; height:1px; width:1px; background-color:black;}

     
    </style>
  </head>
  <body>
    <div class="board"></div>
  </body>
</html>
